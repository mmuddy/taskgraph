{% extends 'taskgraph/base.html' %}

{% load staticfiles %}

{% block title_block %}
    View
{% endblock %}

{% block additional_head_block %}

    <style>

        #cy {
            float: left;
            width: 100%;
            height: 480px;
            color: #337ab7;
        }

        .qtip_margin {}

    </style>

{% endblock %}

{% block navbar_list_block %}
    <ul class="nav navbar-nav">
        <li class="nav-item"><a href="{% url 'projects'%}">Projects</a>
        </li>
        <li class="divider-vertical"></li>
        <li class="nav-item active"><a href="{% url 'view'%}">View</a>
        </li>
        <li class="divider-vertical"></li>
        <li class="nav-item"><a href="{% url 'edit'%}">Edit</a>
        </li>
        <!--<li class="divider-vertical"></li>
        <li class="nav-item"><a href="{% url 'analysis'%}">Analysis</a>
        </li>-->
    </ul>
{% endblock %}

{% block body_block %}
    <script>


            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var changes = [];

            var csrftoken = getCookie('csrftoken');

            function csrfSafeMethod(method) {
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            function sameOrigin(url) {
                var host = document.location.host;
                var protocol = document.location.protocol;
                var sr_origin = '//' + host;
                var origin = protocol + sr_origin;
                return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                    (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                    // or any other URL that isn't scheme relative or absolute i.e relative.
                    !(/^(\/\/|http:|https:).*/.test(url));
            }

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            function sendpost() {
                $.post( window.location.toString().substr(0, window.location.toString().slice(0, -1).lastIndexOf("/")) + "/change-graph/",
                    {history: JSON.stringify(changes)}).done(function(data){alert(data);location.reload()});
            }
            var colors1 = ['#f8f8f8', '#efebe9', '#eceff1', '#ffebee', '#fce4ec', '#f3e5f5', '#ede7f6', '#e8eaf6', '#e3f2fd', '#e1f5fe',
                           '#e0f7fa', '#e0f2f1', '#e8f5e9', '#f1f8e9', '#f9fbe7', '#fffde7', '#fff8e1', '#fff3e0', '#fbe9e7']
            var colors3 = ['#cccccc', '#d7ccc8', '#cfd8dc', '#ffcdd2', '#f8bbd0', '#e1bee7', '#d1c4e9', '#c5cae9', '#bbdefb', '#b3e5fc',
                           '#b2ebf2', '#b2dfdb', '#c8e6c9', '#dcedc8', '#f0f4c3', '#fff9c4', '#ffecb3', '#ffe0b2', '#ffccbc']
            var colors2 = ['#bbbbbb', '#bcaaa4', '#b0bec5', '#ef9a9a', '#f48fb1', '#ce93d8', '#b39ddb', '#9fa8da', '#90caf9', '#81d4fa',
                           '#80deea', '#80cbc4', '#a5d6a7', '#c5e1a5', '#e6ee9c', '#fff59d', '#ffe082', '#ffcc80', '#ffab91']

            var change_colors;
			$(function(){



				var cy = window.cy = cytoscape({
					container: document.getElementById('cy'),

					style: [
						{
							selector: 'node',
							style: {
								'shape': 'roundrect',
								'width': '70px',
								'height': '55px',
								'content': 'data(name)',
                                'color': '#666',
								'text-outline-width': 4,
								'text-outline-color': 'data(color1)',
								'text-valign': 'center',
								'background-color': 'data(color1)',
								'border-width': '3px',
								'border-color': 'data(color2)'
							}
						},

						{
							selector: 'edge',
							style: {

								'width': 3,
								'target-arrow-shape': 'triangle',
								'line-color': '#BBB',
								'target-arrow-color': '#BBB',
								'curve-style': 'bezier'
							}
						},

						{
							selector: 'node:selected',
							style: {
						        'border-color': 'data(color2)',
						        'background-color': 'data(color3)',
                                'text-outline-color': 'data(color3)',
                                'color' : '#444'
						        //'text-outline-color': '#b89fdd'
							}

						},

						{
							selector: 'edge:selected',
							style: {

								'width': 3,
								'target-arrow-shape': 'triangle',
								'line-color': '#333',
								'target-arrow-color': '#333',
								'curve-style': 'bezier'
							}
						},
					],

					elements: {
						nodes: [

						{% for i in all_nodes %}
						    { data:
                            { id: '{{i.0}}', name: '{{i.1}}', type: '{{i.2}}',

                                 color1: colors1[{{i.6}}],

                                 color2: colors2[{{i.6}}],

                                 color3: colors3[{{i.6}}],

                                 info: {

                                    {% for j in i.3 %}

                                        '{{j.0}}': '{{j.1}}',

                                    {% endfor %}

                                 } } },
						{% endfor %}

						],
						edges: [

						    {% for i in all_edges %}
						        { data: { source: '{{i.0}}', target: '{{i.1}}', type: '{{i.2}}', edge_id: '{{i.3}}' } },
						    {% endfor %}
						]
					},

					layout: {
						name: 'preset',

						positions: {

						    {% for i in coords %}
						        '{{i.0}}': {x: {{i.1}}, y: {{i.2}} },
						    {% endfor %}
						}
					},


				});

				cy.on('mouseover', 'node', function(event) {
					    var node = event.cyTarget;
				    	$(".qtip").remove();

				    	if(isTipsEnabled){
				    		var attrs = Object.keys(node.attr('info'));
					    	var s = '<b>id</b>: '+node.attr('name')+'<br>';
					    	for (var i = 0; i < attrs.length; i++) {
					    		s+='<b>'+attrs[i]+'</b>: '+node.attr('info')[attrs[i]]+'<br>'
					    	}
						    node.qtip({
						         content: s,
				         		 style: { classes: 'qtip-bootstrap' },
						         show: {
						         	solo: true,
						            event: event.type,
						            ready: true
						         },
						         hide: {
						            event: 'mouseout unfocus'
						         }
						    }, event);
				    	}

					});

					cy.on('mouseover', 'edge', function(event) {
					    var edge = event.cyTarget;
				    	$(".qtip").remove();

				    	if(isTipsEnabled){
				    		document.styleSheets[4].cssRules[1].style.marginLeft = event.originalEvent.clientX + 'px';
					 		document.styleSheets[4].cssRules[1].style.marginTop  = event.originalEvent.clientY + 'px';

						    edge.qtip({
						         content: "<b>Type</b>: "+edge.attr('type'),
				         		 style: { classes: 'qtip-bootstrap qtip_margin',},
						         show: {
						         	solo: true,
						            event: event.type,
						            ready: true
						         },
						         hide: {
						            event: 'mouseout unfocus'
						         }
						    }, event);
				    	}



					});

					var isTipsEnabled = true;

					var disableTips = {
								id: 'disableTips',
                                title: 'Disable tips',
                                selector: '*',
                                onClickFunction: function (event) {
                                	cxt.insertBeforeMenuItem(enableTips, 'disableTips');
                                  	cxt.removeMenuItem('disableTips');
                                  	isTipsEnabled = false;
                                },
                                hasTrailingDivider: true,
                                disabled: false,
                                coreAsWell: true
					}

					var enableTips = {
								id: 'enableTips',
                                title: 'Enable tips',
                                selector: '*',
                                onClickFunction: function (event) {
                                	cxt.insertBeforeMenuItem(disableTips, 'enableTips');
                                  	cxt.removeMenuItem('enableTips');
                                  	isTipsEnabled = true;
                                },
                                hasTrailingDivider: true,
                                disabled: false,
                                coreAsWell: true
					}

                    var normalSize = {
                    			id: 'normalSize',
                    			title: 'Normal size',
                    			selector: '*',
                    			onClickFunction: function (event) {
                    				cy.fit();
                                },
                                hasTrailingDivider: true,
                                disabled: false,
                                coreAsWell: true
                    }

					var cxt = cy.contextMenus({
                        menuItems: [
                        	 normalSize,
                        	 disableTips,
                        ],
                        menuItemClasses: ['qtip-bootstrap'],
                        contextMenuClasses: ['qtip-bootstrap']
                    });

                    change_colors = function(){
                        var index = document.getElementById('select_color').selectedIndex

                        console.log(cy.nodes(':selected'))

                        var selectedNodes = cy.nodes(':selected')
                        for(var i = 0; i < selectedNodes.length; i++){

                            node = selectedNodes[i]
                            changes.push({
                                'type' : 'task',
                                'action' : 'changeColor',
                                'id' : node.attr(node.attr('id')[0] !='_'? 'name': 'id'),
                                'color' : index
                             })

                            node.data('color1', colors1[index - 1])
                            node.data('color2', colors2[index - 1])
                            node.data('color3', colors3[index - 1])
                            cy.forceRender()

                        }

                        selectedNodes.unselect();

                        document.getElementById('select_color').selectedIndex = 0
                    }

			});


		</script>

        {% include 'taskgraph/alerts.html' %}

          <select id="select_color">
            <option selected="selected" disabled="disabled" hidden="hidden">Choose color</option>
            <option onclick="change_colors()" style="background:#F8F8F8">default</option>
            <option onclick="change_colors()" style="background:#D7CCC8">brown</option>
            <option onclick="change_colors()" style="background:#CFD8DC">steel</option>
            <option onclick="change_colors()" style="background:#FFCDD2">pink</option>
            <option onclick="change_colors()" style="background:#F8BBD0">violet</option>
            <option onclick="change_colors()" style="background:#E1BEE7">plum</option>
            <option onclick="change_colors()" style="background:#D1C4E9">purple</option>
            <option onclick="change_colors()" style="background:#C5CAE9">cobalt</option>
            <option onclick="change_colors()" style="background:#BBDEFB">blue</option>
            <option onclick="change_colors()" style="background:#B3E5FC">aqua</option>
            <option onclick="change_colors()" style="background:#B2EBF2">sea</option>
            <option onclick="change_colors()" style="background:#B2DFDB">aquamarine</option>
            <option onclick="change_colors()" style="background:#C8E6C9">forest</option>
            <option onclick="change_colors()" style="background:#DCEDC8">green</option>
            <option onclick="change_colors()" style="background:#F0F4C3">lime</option>
            <option onclick="change_colors()" style="background:#FFF9C4">yellow</option>
            <option onclick="change_colors()" style="background:#FFECB3">orange</option>
            <option onclick="change_colors()" style="background:#FFE0B2">bisque</option>
            <option onclick="change_colors()" style="background:#FFCCBC">peach</option>
          <select/>

        <input type='button' value="Save changes" onclick='sendpost()'/>

		<div id="cy"></div>


{% endblock %}
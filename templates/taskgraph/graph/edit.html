{% extends 'taskgraph/base.html' %}

{% load staticfiles %}

{% block title_block %}
Edit
{% endblock %}

{% block additional_head_block %}

    <style>

        #cy {
            float: left;
            width: 100%;
            height: 520px;
            margin-top: -20px;
            color: #337ab7;
        }

        .qtip_margin {}

    </style>

{% endblock %}

{% block navbar_list_block %}
    <ul class="nav navbar-nav">
        <li class="nav-item"><a href="{% url 'projects'%}">Projects</a>
        </li>
        <li class="divider-vertical"></li>
        <li class="nav-item"><a href="{% url 'view'%}">View</a>
        </li>
        <li class="divider-vertical"></li>
        <li class="nav-item active"><a href="{% url 'edit'%}">Edit</a>
        </li>
        <li class="divider-vertical"></li>
        <li class="nav-item"><a href="{% url 'analysis'%}">Analysis</a>
        </li>
    </ul>
{% endblock %}

{% block body_block %}
{% csrf_token %}
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var changes = [];

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function sameOrigin(url) {
            var host = document.location.host;
            var protocol = document.location.protocol;
            var sr_origin = '//' + host;
            var origin = protocol + sr_origin;
            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                // or any other URL that isn't scheme relative or absolute i.e relative.
                !(/^(\/\/|http:|https:).*/.test(url));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        function sendpost() {
			$.post( window.location.toString().substr(0, window.location.toString().slice(0, -1).lastIndexOf("/")) + "/change-graph/",
			    JSON.stringify({'ids': [12, 3, 4, 5, 6]}))
				.done(location.reload());
		}


		$(function(){

				var cy = window.cy = cytoscape({
					container: document.getElementById('cy'),

					style: [
						{
							selector: 'node',
							style: {
								'shape': 'roundrect',
								'width': '70px',
								'height': '55px',
								'content': 'data(name)',
                                'color': '#666',
								'text-outline-width': 4,
								'text-outline-color': 'data(color1)',
								'text-valign': 'center',
								'background-color': 'data(color1)',
								'border-width': '3px',
								'border-color': 'data(color2)'
							}
						},

						{
							selector: 'edge',
							style: {

								'width': 3,
								'target-arrow-shape': 'triangle',
								'line-color': '#BBB',
								'target-arrow-color': '#BBB',
								'curve-style': 'bezier'
							}
						},

						{
							selector: 'node:selected',
							style: {
						        'border-color': '#999',
						        'background-color': '#CCC',
                                'text-outline-color': '#CCC',
                                'color' : '#444'
						        //'text-outline-color': '#b89fdd'
							}

						}
					],

					elements: {
						nodes: [

						{% for i in all_nodes %}
						    { data:
                            { id: '{{i.0}}', name: '{{i.1}}', type: '{{i.2}}',
						         {% if i.2 == 'StartNode' %}
                                     color1: '#f8f8f8', color2: '#BBB'
                                 {% else %}
                                     color1: '#f8f8f8', color2: '#BBB'
                                 {% endif %},

                                 info: {

                                    {% for j in i.3 %}

                                        '{{j.0}}': '{{j.1}}',

                                    {% endfor %}

                                 } } },
						{% endfor %}

						],
						edges: [

						    {% for i in all_edges %}
						        { data: { source: '{{i.0}}', target: '{{i.1}}', type: '{{i.2}}' } },
						    {% endfor %}
						]
					},

					layout: {
						name: 'preset',

						positions: {

						    {% for i in coords %}

						        '{{i.0}}': {x: {{i.1}}, y: {{i.2}} },

						    {% endfor %}
						}
					},


				});

				cy.on('mouseover', 'node', function(event) {
                    var node = event.cyTarget;
                    $(".qtip").remove();
                    var attrs = Object.keys(node.attr('info'));
                    var s = '';
                    for (var i = 0; i < attrs.length; i++) {
                        s+='<b>'+attrs[i]+'</b>: '+node.attr('info')[attrs[i]]+'<br>'
                    }
                    node.qtip({
                         content: s,
                         style: { classes: 'qtip-bootstrap' },
                         show: {
                            solo: true,
                            event: event.type,
                            ready: true
                         },
                         hide: {
                            event: 'mouseout unfocus'
                         }
                    }, event);

                });

                cy.on('mouseover', 'edge', function(event) {
					    var edge = event.cyTarget;
				    	$(".qtip").remove();

				 		document.styleSheets[4].cssRules[1].style.marginLeft = event.originalEvent.clientX + 'px';
				 		document.styleSheets[4].cssRules[1].style.marginTop  = event.originalEvent.clientY + 'px';

					    edge.qtip({
					         content: "<b>Type</b>: "+edge.attr('type'),
			         		 style: { classes: 'qtip-bootstrap qtip_margin',},
					         show: {
					         	solo: true,
					            event: event.type,
					            ready: true
					         },
					         hide: {
					            event: 'mouseout unfocus'
					         }
					    }, event);

					});


					var remove = {
                                id: 'remove',
                                title: 'Remove',
                                selector: 'node, edge',
                                onClickFunction: function (event) {

                                  var target = event.cyTarget;
                                  if(target.isEdge()){
                                  	target.remove();
										changes.push({
	                                  	'type': 'relation',
	                                  	'source': target.attr('source'),
	                                  	'target': target.attr('target'),
	                                  	'action': 'delete'
	                                  });
                                	console.log(changes);
                                  }

                                },
                                hasTrailingDivider: true,
                                disabled: false,
                                coreAsWell: false
                    }

					var newEdge = {
                                id: 'newEdge',
                                title: 'New edge',
                                selector: 'node',
                                onClickFunction: function (event) {
                                	cxt.removeMenuItem('newEdge');
                                	cxt.appendMenuItem(createEdge);
                                	cxt.appendMenuItem(finish);
                                	cxt.firstEdge = event.cyTarget;
                                },
                                hasTrailingDivider: true,
                                disabled: false,
                                coreAsWell: false
                    }

					var createEdge = {
                                id: 'createEdge',
                                title: 'Create edge',
                                selector: 'node',
                                onClickFunction: function (event) {
                                	cy.add({
                                		group: 'edges',
                                		data: { source: cxt.firstEdge.attr('id'),
                                				target: event.cyTarget.attr('id'),
                                				type: 'relation' }
                                	});
                                	changes.push({
                                		'type': 'relation',
                                		'source': cxt.firstEdge.attr('id'),
	                                  	'target': event.cyTarget.attr('id'),
	                                  	'action': 'add'
                                	});
                                	console.log(changes);
                                },
                                hasTrailingDivider: true,
                                disabled: false,
                                coreAsWell: false
                    }

                    var finish = {
                                id: 'finish',
                                title: 'Finish',
                                selector: '*',
                                onClickFunction: function (event) {
                                	cxt.removeMenuItem('createEdge');
                                	cxt.removeMenuItem('finish');
                                	cxt.appendMenuItem(newEdge);
                                },
                                hasTrailingDivider: true,
                                disabled: false,
                                coreAsWell: true
                    }

					var cxt = cy.contextMenus({
                        menuItems: [
                             remove,
                             newEdge,
                        ],
                        menuItemClasses: ['custom-menu-item'],
                        contextMenuClasses: ['custom-context-menu']
                    });

			});

		</script>

        {% include 'taskgraph/alerts.html' %}

        <input type='button' onclick='sendpost()' value="Save changes"/>

		<div id="cy"></div>
{% endblock %}